{% extends 'base.html' %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="calendar-wrapper" id="calendarWrapper">
  <div class="calendar-section" id="calendarSection">
    <div class="calendar-header">
      <button class="nav-btn" id="prevMonth">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6" />
        </svg>
      </button>
      <div class="header-center">
        <h1 id="monthYear">{{ current_month_name }} {{ current_year }}</h1>
        <p class="calendar-subtitle"> –û—Ä–≥–∞–Ω—ñ–∑—É–π —Å–≤–æ—î –∂–∏—Ç—Ç—è —Å—Ç–∏–ª—å–Ω–æ</p>
      </div>
      <button class="nav-btn" id="nextMonth">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 18l6-6-6-6" />
        </svg>
      </button>
    </div>

    <div class="current-time glass">
      <span id="currentTime">üïê –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
      <span id="currentDate"></span>
    </div>

    <div class="calendar-weekdays">
      {% for wd in ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–ù–¥'] %}
      <div class="weekday">{{ wd }}</div>
      {% endfor %}
    </div>

    <div class="calendar-grid" id="calendarGrid">
      {% for week in weeks %}
      {% for day in week %}
      {% if day %}
      <div class="day-cell glass {% if day.is_today %}today{% endif %}" data-date="{{ day.date }}">
        <button class="day-button" data-date="{{ day.date }}">
          <div class="day-number">{{ day.day_number }}</div>
          <div class="day-stats">
            {% if day.tasks_count > 0 %}
            <span class="tasks-badge">{{ day.tasks_count }}</span>
            {% endif %}
            {% if day.stickers %}
            <span class="day-stickers">{{ day.stickers|join('') }}</span>
            {% endif %}
          </div>
        </button>

        <div class="day-tasks-preview">
          {% for task in day.tasks[:3] %}
          <div class="task-preview {% if task.is_completed %}completed{% endif %}" {% if task.category
            %}style="border-left: 3px solid {{ task.category.color }}" {% endif %}>
            <input type="checkbox" class="task-preview-checkbox" data-id="{{ task._id }}" {% if task.is_completed
              %}checked{% endif %}>
            {% if task.category %}
            <span class="task-category-icon">{{ task.category.icon }}</span>
            {% endif %}
            <label class="task-preview-title">{{ task.title }}</label>
          </div>
          {% endfor %}
          {% if day.tasks|length > 3 %}
          <div class="more-tasks">+{{ day.tasks|length - 3 }} —â–µ</div>
          {% endif %}
        </div>
      </div>
      {% else %}
      <div class="day-cell empty"></div>
      {% endif %}
      {% endfor %}
      {% endfor %}
    </div>
  </div>

  <aside class="event-panel glass" id="eventPanel">
    <div class="panel-header">
      <h2 id="panelDate">–û–±–µ—Ä—ñ—Ç—å –¥–µ–Ω—å</h2>
      <div class="panel-header-actions">
        <button class="analyze-day-btn" id="openAnalysisBtn" title="–ü—ñ–¥—Å—É–º–∫–∏ –¥–Ω—è —Ç–∞ –∞–Ω–∞–ª—ñ–∑ –Ω–∞—Å—Ç—Ä–æ—é">
           –ê–Ω–∞–ª—ñ–∑
        </button>
        <button class="close-panel" id="closePanel">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>

    <div class="panel-tabs">
      <button class="tab-btn active" data-tab="tasks">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 11l3 3L22 4" />
          <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
        </svg>
        <span>–ó–∞–≤–¥–∞–Ω–Ω—è</span>
      </button>
      <button class="tab-btn" data-tab="create">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 5v14M5 12h14" />
        </svg>
        <span>–°—Ç–≤–æ—Ä–∏—Ç–∏</span>
      </button>
      <button class="tab-btn" data-tab="stickers">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10" />
          <path d="M8 14s1.5 2 4 2 4-2 4-2" />
          <line x1="9" y1="9" x2="9.01" y2="9" />
          <line x1="15" y1="9" x2="15.01" y2="9" />
        </svg>
        <span>–°—Ç—ñ–∫–µ—Ä–∏</span>
      </button>
    </div>

    <div class="panel-content">
      <div class="tab-content active" id="tabTasks">
        <div class="tasks-header">
          <h3>üìã –°–ø–∏—Å–æ–∫ –∑–∞–≤–¥–∞–Ω—å</h3>
          <span class="tasks-count" id="tasksCount">0</span>
        </div>
        <div class="panel-tasks-list" id="panelTasks">
          <div class="empty">üìù –ù–µ–º–∞—î –∑–∞–¥–∞—á –Ω–∞ —Ü–µ–π –¥–µ–Ω—å</div>
        </div>
      </div>

      <div class="tab-content" id="tabCreate">
        <h3>‚ú® –ù–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è</h3>

        <div class="categories-section">
          <label class="section-label">üè∑Ô∏è –ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
          <div class="categories-grid" id="categoriesGrid">
            {% for cat in categories %}
            <button class="category-pill" data-id="{{ cat._id }}" data-color="{{ cat.color_hex }}"
              data-icon="{{ cat.icon }}" data-name="{{ cat.name_ua }}">
              <span class="category-icon">{{ cat.icon }}</span>
              <span class="category-name">{{ cat.name_ua }}</span>
              <span class="category-indicator" style="background: {{ cat.color_hex }}"></span>
            </button>
            {% endfor %}
          </div>
        </div>

        <div class="selected-category-display" id="selectedCategoryDisplay" style="display:none;">
          <span id="selectedCategoryIcon"></span>
          <span id="selectedCategoryName"></span>
          <button type="button" id="clearCategory" class="clear-category-btn">‚úï</button>
        </div>

        <form id="taskForm">
          <input type="hidden" id="taskId" value="">
          <input type="hidden" id="selectedCategory" value="">

          <div class="form-group">
            <label>üìù –ù–∞–∑–≤–∞</label>
            <input type="text" id="taskTitle" placeholder="–ù–∞–∑–≤–∞ –∑–∞–≤–¥–∞–Ω–Ω—è..." required>
          </div>

          <div class="form-group">
            <label>üìÑ –û–ø–∏—Å</label>
            <textarea id="taskDescription" placeholder="–î–æ–¥–∞–π—Ç–µ –æ–ø–∏—Å (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)" rows="3"></textarea>
          </div>

          <div class="form-group">
            <label>‚è∞ –ß–∞—Å</label>
            <input type="time" id="taskTime">
          </div>

          <div class="form-actions">
            <button type="submit" id="saveTaskBtn" class="btn-primary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                <polyline points="17 21 17 13 7 13 7 21" />
                <polyline points="7 3 7 8 15 8" />
              </svg>
              <span>–ó–±–µ—Ä–µ–≥—Ç–∏</span>
            </button>
            <button type="button" id="deleteTaskBtn" class="btn-danger" style="display:none">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6" />
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
              </svg>
              <span>–í–∏–¥–∞–ª–∏—Ç–∏</span>
            </button>
          </div>
        </form>
      </div>

      <div class="tab-content" id="tabStickers">
        <div class="stickers-header">
          <h3>üé® –°—Ç—ñ–∫–µ—Ä–∏</h3>
          <p class="stickers-hint">–ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å –Ω–∞ –¥–µ–Ω—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—ñ</p>
        </div>
        <div class="stickers-grid">
          {% for sticker in available_stickers %}
          <button class="sticker-btn" draggable="true" data-sticker="{{ sticker }}">{{ sticker }}</button>
          {% endfor %}
        </div>
      </div>
    </div>
  </aside>
  <div class="day-entry-modal-overlay" id="dayEntryModalOverlay">
    <div class="day-entry-modal glass" id="dayEntryModal">
      <div class="modal-header">
        <h2>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è –¥–Ω—è</h2>
        <button type="button" class="modal-close" id="closeDayEntryModal">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div class="modal-content">
        <form id="dayEntryForm" class="day-entry-form">
          <input type="hidden" id="entryDate" value="">

          <div class="form-group">
            <label for="dayDescription">üìù –û–ø–∏—à–∏ —Å–≤—ñ–π –¥–µ–Ω—å:</label>
            <textarea id="dayDescription" placeholder="–©–æ —Ç–∏ —Ä–æ–±–∏–≤ —Å—å–æ–≥–æ–¥–Ω—ñ? –Ø–∫–∏–º –±—É–≤ —Ç–≤—ñ–π –¥–µ–Ω—å?..." rows="5"
              required></textarea>
          </div>

          <div class="form-group">
            <label for="moodRating">üòä –û—Ü—ñ–Ω–∫–∞ –Ω–∞—Å—Ç—Ä–æ—é (1-10):</label>
            <div class="mood-slider-container">
              <input type="range" id="moodRating" min="1" max="10" value="5" class="mood-slider">
              <div class="mood-display">
                <span class="mood-value">5</span>
                <span class="mood-emoji" id="moodEmoji">üòê</span>
              </div>
            </div>
            <div class="mood-labels">
              <span>–ü–æ–≥–∞–Ω–æ</span>
              <span>–ß—É–¥–æ–≤–æ</span>
            </div>
          </div>

          <div class="form-group">
            <label>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–Ω—è:</label>
            <div class="day-stats-info">
              <div class="stat-item">
                <span class="stat-label">–ó–∞–≤–¥–∞–Ω—å –≤–∏–∫–æ–Ω–∞–Ω–æ:</span>
                <span class="stat-value" id="completedTasksCount">0/0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">–ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ–≥–æ —á–∞—Å—É:</span>
                <span class="stat-value" id="plannedTimeCount">0 —Ö–≤</span>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-primary modal-action-btn" id="submitDayEntryBtn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                <polyline points="22 4 12 14.01 9 11.01" />
              </svg>
              <span>–ê–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –¥–µ–Ω—å</span>
            </button>
            <button type="button" class="btn-secondary modal-action-btn" id="cancelDayEntryBtn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12" />
              </svg>
              <span>–ó–∞–∫—Ä–∏—Ç–∏</span>
            </button>
          </div>
        </form>

        <div class="ai-analysis-results" id="aiAnalysisResults" style="display: none;">
          <div class="results-header">
            <h3>ü§ñ –ê–Ω–∞–ª—ñ–∑ –¥–Ω—è –®–Ü</h3>
            <button type="button" class="results-close" id="closeResults">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12" />
              </svg>
            </button>
          </div>

          <div class="results-content">
            <div class="result-card mood-result">
              <div class="result-label">–í–∏—è–≤–ª–µ–Ω–∏–π –Ω–∞—Å—Ç—Ä—ñ–π:</div>
              <div class="result-value" id="aiMoodResult">
                <span class="mood-badge" id="aiMoodBadge">üòê –ù–µ–π—Ç—Ä–∞–ª—å–Ω–∏–π</span>
              </div>
            </div>

            <div class="result-card">
              <div class="result-label">–†–µ–∑—é–º–µ –¥–Ω—è –≤—ñ–¥ –®–Ü:</div>
              <div class="result-value summary-text" id="aiSummaryResult">
                –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...
              </div>
            </div>

            
            <div class="result-card chart-container" style="position: relative; height: 220px; margin-top: 15px;">
                <div class="result-label" style="margin-bottom: 10px;">üìà –î–∏–Ω–∞–º—ñ–∫–∞ (–æ—Å—Ç–∞–Ω–Ω—ñ 7 –¥–Ω—ñ–≤):</div>
                <canvas id="moodDynamicsChart"></canvas>
            </div>

            <div class="result-card productivity-result">
              <div class="result-label">–†—ñ–≤–µ–Ω—å –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ:</div>
              <div class="productivity-bar">
                <div class="productivity-fill" id="productivityFill" style="width: 0%">
                  <span class="productivity-text" id="productivityScore">0%</span>
                </div>
              </div>
            </div>

            <div class="result-card">
              <div class="result-label">–û—Ü—ñ–Ω–∫–∞ AI:</div>
              <div class="result-value">
                <span class="score-display" id="aiScoreDisplay">0/100</span>
              </div>
            </div>

            <div class="results-actions">
              <button type="button" class="btn-primary" id="saveAnalysisBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                </svg>
                <span>–ó–±–µ—Ä–µ–≥—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç</span>
              </button>
              <button type="button" class="btn-secondary" id="newAnalysisBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 4v6h6M23 20v-6h-6" />
                  <path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36" />
                </svg>
                <span>–ù–æ–≤–∞ –æ—Ü—ñ–Ω–∫–∞</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<style>
  /* –∑–º—ñ–Ω–µ–Ω–æ –∫–æ–ª—ñ—Ä –∫–Ω–æ–∫–ø–∏ –∞–Ω–∞–ª—ñ–∑—É*/
  .panel-header-actions {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .analyze-day-btn {
    background: rgba(255, 123, 176, 0.15);
    border: 1px solid rgba(255, 123, 176, 0.4);
    color: #ff7bb0;
    padding: 6px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.85rem;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .analyze-day-btn:hover {
    background: #ff7bb0;
    color: white;
    box-shadow: 0 0 12px rgba(255, 123, 176, 0.5);
    transform: translateY(-1px);
  }

  /* Modal Overlay */
  .day-entry-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .day-entry-modal-overlay.active {
    display: flex;
    opacity: 1;
  }

  .day-entry-modal {
    background: linear-gradient(135deg, rgba(25, 25, 35, 0.95) 0%, rgba(40, 40, 55, 0.95) 100%);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 20px;
    width: 90%;
    max-width: 600px;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: scale(0.9) translateY(20px);
    }

    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  }

  .modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
    background: linear-gradient(135deg, #ff7bb0 0%, #ffa8d5 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .modal-close {
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.6);
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .modal-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #ffffff;
  }

  .modal-content {
    padding: 24px;
    overflow-y: auto;
    max-height: calc(85vh - 80px);
  }

  /* Form Group */
  .day-entry-form .form-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 20px;
  }

  .day-entry-form label {
    font-size: 0.95rem;
    color: rgba(255, 255, 255, 0.9);
    font-weight: 500;
  }

  .day-entry-form textarea {
    width: 100%;
    padding: 14px 16px;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    background: rgba(255, 255, 255, 0.03);
    color: #ffffff;
    font-size: 0.95rem;
    font-family: inherit;
    resize: vertical;
    min-height: 120px;
  }

  .day-entry-form textarea:focus {
    outline: none;
    border-color: #ff7bb0;
    background: rgba(255, 255, 255, 0.06);
    box-shadow: 0 0 0 3px rgba(255, 123, 176, 0.1);
  }

  /* Mood Slider */
  .mood-slider-container {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .mood-slider {
    flex: 1;
    height: 6px;
    border-radius: 3px;
    background: linear-gradient(90deg, #ff6b6b 0%, #ffd93d 50%, #51cf66 100%);
    outline: none;
    -webkit-appearance: none;
    appearance: none;
  }

  .mood-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #ff7bb0;
    cursor: pointer;
    box-shadow: 0 0 10px rgba(255, 123, 176, 0.5);
    transition: all 0.2s;
  }

  .mood-slider::-webkit-slider-thumb:hover {
    transform: scale(1.2);
    box-shadow: 0 0 15px rgba(255, 123, 176, 0.7);
  }

  .mood-slider::-moz-range-thumb {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #ff7bb0;
    cursor: pointer;
    border: none;
    box-shadow: 0 0 10px rgba(255, 123, 176, 0.5);
    transition: all 0.2s;
  }

  .mood-display {
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 70px;
  }

  .mood-value {
    font-size: 1.2rem;
    font-weight: 700;
    color: #ff7bb0;
  }

  .mood-emoji {
    font-size: 1.5rem;
  }

  .mood-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.6);
  }

  /* Day Stats */
  .day-stats-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    background: rgba(255, 255, 255, 0.02);
    padding: 16px;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.08);
  }

  .stat-item {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .stat-label {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.6);
  }

  .stat-value {
    font-size: 1.1rem;
    font-weight: 600;
    color: #ff7bb0;
  }

  /* Form Actions */
  .form-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
  }

  .modal-action-btn {
    flex: 1;
    padding: 12px 20px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s;
  }

  .btn-primary {
    background: #ff7bb0;
    color: white;
  }

  .btn-primary:hover {
    background: #ff5a9a;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 123, 176, 0.4);
  }

  .btn-primary:active {
    transform: translateY(0);
  }

  .btn-secondary {
    background: rgba(255, 255, 255, 0.08);
    color: rgba(255, 255, 255, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .btn-secondary:hover {
    background: rgba(255, 255, 255, 0.12);
    color: #ffffff;
  }

  /* AI Results */
  .ai-analysis-results {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 16px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  }

  .results-header h3 {
    margin: 0;
    font-size: 1.2rem;
    color: #ffffff;
  }

  .results-close {
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.6);
    cursor: pointer;
    padding: 4px;
    display: flex;
    align-items: center;
  }

  .results-close:hover {
    color: #ffffff;
  }

  .result-card {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 16px;
  }

  .result-label {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: 8px;
  }

  .result-value {
    font-size: 1rem;
    color: #ffffff;
  }

  .mood-badge {
    display: inline-block;
    padding: 8px 16px;
    border-radius: 20px;
    background: linear-gradient(135deg, rgba(255, 123, 176, 0.2) 0%, rgba(255, 200, 221, 0.1) 100%);
    border: 1px solid rgba(255, 123, 176, 0.3);
    font-weight: 600;
    font-size: 1rem;
  }

  .summary-text {
    line-height: 1.6;
    color: rgba(255, 255, 255, 0.85);
  }

  .productivity-bar {
    width: 100%;
    height: 32px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 16px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.08);
  }

  .productivity-fill {
    height: 100%;
    background: linear-gradient(90deg, #51cf66 0%, #94d82d 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: width 0.5s ease;
  }

  .productivity-text {
    color: white;
    font-weight: 700;
    font-size: 0.9rem;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
  }

  .score-display {
    display: inline-block;
    padding: 8px 16px;
    border-radius: 12px;
    background: rgba(255, 123, 176, 0.1);
    border: 1px solid rgba(255, 123, 176, 0.3);
    font-size: 1.1rem;
    font-weight: 700;
    color: #ff7bb0;
  }

  .results-actions {
    display: flex;
    gap: 12px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid rgba(255, 255, 255, 0.08);
  }

  .results-actions button {
    flex: 1;
    padding: 10px 16px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: all 0.3s;
  }

  /* Scrollbar */
  .modal-content::-webkit-scrollbar {
    width: 6px;
  }

  .modal-content::-webkit-scrollbar-track {
    background: transparent;
  }

  .modal-content::-webkit-scrollbar-thumb {
    background: rgba(255, 123, 176, 0.4);
    border-radius: 3px;
  }

  .modal-content::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 123, 176, 0.6);
  }

  @media (max-width: 768px) {
    .day-entry-modal {
      width: 95%;
      max-height: 90vh;
    }

    .day-stats-info {
      grid-template-columns: 1fr;
    }

    .form-actions {
      flex-direction: column;
    }

    .modal-action-btn {
      width: 100%;
    }
  }

  :root {
    --glass-bg: rgba(255, 255, 255, 0.04);
    --glass-border: rgba(255, 255, 255, 0.08);
    --accent: #ff7bb0;
    --accent-hover: #ff5a9a;
    --panel-bg: rgba(18, 18, 20, 0.92);
    --text-primary: #ffffff;
    --text-secondary: rgba(255, 255, 255, 0.7);
    --shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  * {
    transition: var(--transition);
  }

  body {
    background: linear-gradient(135deg, #453840 0%, #383b45 100%);
    min-height: 100vh;
  }

  .calendar-wrapper {
    display: flex;
    gap: 24px;
    padding: 24px;
    align-items: flex-start;
    min-height: calc(100vh - 48px);
    max-width: 1600px;
    margin: 0 auto;
  }

  .calendar-section {
    flex: 1;
    transition: var(--transition);
  }

  .calendar-section.full-width {
    max-width: 100%;
  }

  .calendar-header {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 32px;
    gap: 48px;
    animation: fadeIn 0.6s ease-out;
  }

  .header-center {
    text-align: center;
  }

  .header-center h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0 0 8px 0;
    background: linear-gradient(135deg, #ff7bb0 0%, #ffa8d5 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .calendar-subtitle {
    margin: 0;
    color: var(--text-secondary);
    font-size: 1rem;
  }

  .nav-btn {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 12px;
    cursor: pointer;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
  }

  .nav-btn:hover {
    background: rgba(255, 123, 176, 0.2);
    border-color: var(--accent);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 123, 176, 0.3);
  }

  .current-time {
    display: flex;
    gap: 16px;
    align-items: center;
    justify-content: center;
    margin-bottom: 24px;
    padding: 12px 24px;
    border-radius: 16px;
    font-size: 0.95rem;
    animation: slideDown 0.5s ease-out;
  }

  .calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 12px;
    margin-bottom: 12px;
    padding: 0 4px;
  }

  .weekday {
    text-align: center;
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--accent);
    padding: 8px;
    background: var(--glass-bg);
    border-radius: 8px;
    border: 1px solid var(--glass-border);
  }

  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 12px;
    animation: fadeIn 0.8s ease-out;
  }

  .day-cell {
    min-height: 120px;
    border-radius: 16px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
  }

  .day-cell::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    opacity: 0;
    transition: opacity 0.3s;
  }

  .day-cell:hover::before {
    opacity: 1;
  }

  .day-cell.empty {
    background: transparent;
    border: 1px dashed rgba(255, 255, 255, 0.05);
    backdrop-filter: none;
  }

  .day-button {
    all: unset;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    width: 100%;
    cursor: pointer;
    padding: 8px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.02);
  }

  .day-button:hover {
    background: rgba(255, 123, 176, 0.1);
    transform: translateY(-2px);
  }

  .day-number {
    font-weight: 700;
    font-size: 1.3rem;
    color: var(--text-primary);
  }

  .day-stats {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .tasks-badge {
    background: var(--accent);
    color: white;
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 12px;
    font-weight: 600;
  }

  .day-stickers {
    font-size: 1.1rem;
    display: flex;
    gap: 2px;
  }

  .day-tasks-preview {
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding: 0 4px;
  }

  .task-preview {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    padding: 4px 6px;
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.03);
    transition: var(--transition);
    position: relative;
  }

  .task-preview:hover {
    background: rgba(255, 255, 255, 0.06);
  }

  .task-preview.completed {
    opacity: 0.5;
  }

  .task-preview.completed .task-preview-title {
    text-decoration: line-through;
  }

  .task-preview-checkbox {
    width: 16px;
    height: 16px;
    cursor: pointer;
    accent-color: var(--accent);
  }

  .task-category-icon {
    font-size: 0.9rem;
  }

  .task-preview-title {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: var(--text-secondary);
  }

  .more-tasks {
    text-align: center;
    font-size: 0.8rem;
    color: var(--accent);
    padding: 4px;
  }

  .day-cell.today {
    border: 2px solid var(--accent);
    box-shadow: 0 0 20px rgba(255, 123, 176, 0.3);
    animation: pulse 2s infinite;
  }

  .day-cell.selected {
    border-color: var(--accent);
    box-shadow: 0 8px 24px rgba(255, 123, 176, 0.4);
    transform: scale(1.02);
  }

  /* Panel */
  .event-panel {
    width: 440px;
    position: sticky;
    top: 24px;
    background: var(--panel-bg);
    padding: 0;
    border-radius: 20px;
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(20px);
    box-shadow: var(--shadow);
    max-height: calc(100vh - 48px);
    overflow: hidden;
    transform: translateX(0);
    opacity: 1;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1),
      opacity 0.4s ease;
    display: flex;
    flex-direction: column;
  }

  .event-panel.hidden {
    transform: translateX(100%);
    opacity: 0;
    pointer-events: none;
    width: 0;
    margin: 0;
  }

  .panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid var(--glass-border);
  }

  .panel-header h2 {
    font-size: 1.3rem;
    margin: 0;
    color: var(--accent);
  }

  .close-panel {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
  }

  .close-panel:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
  }

  /* Tabs Navigation */
  .panel-tabs {
    display: flex;
    border-bottom: 1px solid var(--glass-border);
    background: rgba(255, 255, 255, 0.02);
  }

  .tab-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    padding: 16px 12px;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    cursor: pointer;
    position: relative;
    font-size: 0.75rem;
    font-weight: 500;
  }

  .tab-btn svg {
    width: 20px;
    height: 20px;
  }

  .tab-btn::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--accent);
    transform: scaleX(0);
    transition: transform 0.3s;
  }

  .tab-btn:hover {
    color: var(--text-primary);
    background: rgba(255, 255, 255, 0.05);
  }

  .tab-btn.active {
    color: var(--accent);
  }

  .tab-btn.active::after {
    transform: scaleX(1);
  }

  /* Tab Content */
  .panel-content {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
  }

  .tab-content {
    display: none;
    animation: fadeIn 0.3s ease-out;
  }

  .tab-content.active {
    display: block;
  }

  .tab-content h3 {
    margin: 0 0 20px 0;
    font-size: 1.1rem;
    color: var(--text-primary);
  }

  /* Tasks Tab */
  .tasks-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .tasks-header h3 {
    margin: 0;
  }

  .tasks-count {
    background: var(--accent);
    color: white;
    font-size: 0.85rem;
    padding: 4px 12px;
    border-radius: 12px;
    font-weight: 600;
  }

  .panel-tasks-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .panel-task-row {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: space-between;
    background: rgba(255, 255, 255, 0.05);
    padding: 14px;
    border-radius: 12px;
    border: 1px solid var(--glass-border);
    position: relative;
  }

  .panel-task-row.has-category {
    border-left-width: 3px;
  }

  .panel-task-row:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: var(--accent);
  }

  .panel-task-row .left {
    display: flex;
    gap: 12px;
    align-items: center;
    flex: 1;
    min-width: 0;
  }

  .panel-task-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: var(--accent);
    flex-shrink: 0;
  }

  .panel-task-category {
    font-size: 1.1rem;
    flex-shrink: 0;
  }

  .panel-task-info {
    flex: 1;
    min-width: 0;
  }

  .panel-task-title {
    font-weight: 500;
    color: var(--text-primary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .panel-task-time {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-top: 4px;
  }

  .panel-task-actions {
    display: flex;
    gap: 4px;
    flex-shrink: 0;
  }

  .edit-task-btn,
  .delete-task-btn-inline {
    background: transparent;
    border: 1px solid var(--glass-border);
    color: var(--text-secondary);
    cursor: pointer;
    padding: 6px 8px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .edit-task-btn:hover {
    background: rgba(255, 123, 176, 0.2);
    border-color: var(--accent);
    color: var(--accent);
  }

  .delete-task-btn-inline:hover {
    background: rgba(255, 107, 107, 0.2);
    border-color: #ff6b6b;
    color: #ff6b6b;
  }

  .empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
    font-style: italic;
  }

  /* Create Tab */
  .section-label {
    display: block;
    font-size: 0.9rem;
    color: var(--text-secondary);
    font-weight: 500;
    margin-bottom: 12px;
  }

  .categories-section {
    margin-bottom: 20px;
  }

  .categories-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
  }

  .category-pill {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--glass-border);
    background: rgba(255, 255, 255, 0.05);
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }

  .category-pill:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateY(-2px);
  }

  .category-pill.active {
    border-color: var(--accent);
    background: rgba(255, 123, 176, 0.2);
  }

  .category-icon {
    font-size: 1.2rem;
  }

  .category-name {
    flex: 1;
    font-size: 0.85rem;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .category-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .selected-category-display {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    border-radius: 12px;
    background: rgba(255, 123, 176, 0.15);
    border: 1px solid var(--accent);
    margin-bottom: 20px;
  }

  #selectedCategoryIcon {
    font-size: 1.2rem;
  }

  #selectedCategoryName {
    flex: 1;
    font-size: 0.9rem;
    color: var(--text-primary);
    font-weight: 500;
  }

  .clear-category-btn {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: var(--text-secondary);
  }

  .clear-category-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    color: var(--text-primary);
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 16px;
  }

  .form-group label {
    font-size: 0.9rem;
    color: var(--text-secondary);
    font-weight: 500;
  }

  .form-group input[type="text"],
  .form-group textarea,
  .form-group input[type="time"] {
    width: 100%;
    padding: 12px 16px;
    border-radius: 12px;
    border: 1px solid var(--glass-border);
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-primary);
    font-size: 0.95rem;
    font-family: inherit;
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--accent);
    background: rgba(255, 255, 255, 0.08);
    box-shadow: 0 0 0 3px rgba(255, 123, 176, 0.1);
  }

  .form-group textarea {
    resize: vertical;
    min-height: 80px;
  }

  .form-actions {
    display: flex;
    gap: 12px;
    margin-top: 20px;
  }

  .form-actions button {
    flex: 1;
    padding: 12px 20px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .btn-primary {
    background: var(--accent);
    color: white;
  }

  .btn-primary:hover {
    background: var(--accent-hover);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 123, 176, 0.4);
  }

  .btn-danger {
    background: #ff6b6b;
    color: white;
  }

  .btn-danger:hover {
    background: #ff5252;
    transform: translateY(-2px);
  }

  /* Stickers Tab */
  .stickers-header {
    margin-bottom: 20px;
  }

  .stickers-header h3 {
    margin: 0 0 8px 0;
  }

  .stickers-hint {
    margin: 0;
    font-size: 0.85rem;
    color: var(--text-secondary);
  }

  .stickers-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
  }

  .sticker-btn {
    border-radius: 12px;
    padding: 12px;
    cursor: grab;
    border: 1px solid var(--glass-border);
    background: rgba(255, 255, 255, 0.05);
    font-size: 1.5rem;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .sticker-btn:hover {
    background: rgba(255, 123, 176, 0.2);
    border-color: var(--accent);
    transform: scale(1.1);
  }

  .sticker-btn:active {
    cursor: grabbing;
    transform: scale(0.95);
  }

  /* Animations */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes pulse {

    0%,
    100% {
      box-shadow: 0 0 20px rgba(255, 123, 176, 0.3);
    }

    50% {
      box-shadow: 0 0 30px rgba(255, 123, 176, 0.5);
    }
  }

  /* Scrollbar */
  .panel-content::-webkit-scrollbar {
    width: 6px;
  }

  .panel-content::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
  }

  .panel-content::-webkit-scrollbar-thumb {
    background: var(--accent);
    border-radius: 10px;
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .calendar-wrapper {
      flex-direction: column;
    }

    .event-panel {
      position: static;
      width: 100%;
      max-height: 500px;
    }

    .event-panel.hidden {
      transform: translateY(100%);
    }

    .calendar-section.full-width {
      max-width: 100%;
    }
  }

  @media (max-width: 768px) {
    .header-center h1 {
      font-size: 1.8rem;
    }

    .calendar-grid {
      gap: 8px;
    }

    .day-cell {
      min-height: 100px;
      padding: 8px;
    }

    .day-number {
      font-size: 1.1rem;
    }

    .categories-grid {
      grid-template-columns: 1fr;
    }

    .stickers-grid {
      grid-template-columns: repeat(4, 1fr);
    }

    .tab-btn span {
      display: none;
    }
  }
</style>

<script>
  // ===== CHART & MODAL LOGIC =====
  let currentSelectedDate = null;
  let moodChartInstance = null; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —ñ–Ω—Å—Ç–∞–Ω—Å –≥—Ä–∞—Ñ—ñ–∫–∞

  function getMoodEmoji(score) {
    if (score <= 2) return 'üò¢';
    if (score <= 4) return 'üòï';
    if (score <= 6) return 'üòê';
    if (score <= 8) return 'üôÇ';
    return 'üòÑ';
  }

  function openDayEntryModal(date) {
    console.log('Opening modal for:', date);
    currentSelectedDate = date;
    const overlay = document.getElementById('dayEntryModalOverlay');
    const modal = document.getElementById('dayEntryModal');

    // Reset Form
    document.getElementById('dayEntryForm').reset();
    document.getElementById('entryDate').value = date;
    document.getElementById('moodRating').value = 5;
    document.getElementById('moodEmoji').textContent = 'üòê';
    document.querySelector('.mood-value').textContent = '5';

    // Load stats
    loadDayStats(date);

    // Show Form, Hide Results
    document.getElementById('aiAnalysisResults').style.display = 'none';
    document.getElementById('dayEntryForm').style.display = 'block';

    overlay.classList.add('active');
  }

  function closeDayEntryModal() {
    const overlay = document.getElementById('dayEntryModalOverlay');
    overlay.classList.remove('active');
    currentSelectedDate = null;
  }

  function loadDayStats(date) {
    console.log('loadDayStats: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è', date);
    
    fetch(`/api/ai/day-stats/${date}`)
      .then(r => {
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.json();
      })
      .then(data => {
        const completedEl = document.getElementById('completedTasksCount');
        const plannedEl = document.getElementById('plannedTimeCount');
        
        if (completedEl) completedEl.textContent = `${data.completed_events}/${data.total_events}`;
        if (plannedEl) plannedEl.textContent = `${data.time_planned_minutes} —Ö–≤`;
      })
      .catch(err => {
        console.error('‚ùå Error loading day stats:', err);
        document.getElementById('completedTasksCount').textContent = '0/0';
        document.getElementById('plannedTimeCount').textContent = '0 —Ö–≤';
      });
  }

  function showAnalysisResults(result) {
    document.getElementById('dayEntryForm').style.display = 'none';
    document.getElementById('aiAnalysisResults').style.display = 'flex';

    const moodEmoji = getMoodEmoji(result.mood_rating || 5);
    document.getElementById('aiMoodBadge').textContent = `${moodEmoji} ${result.mood}`;
    document.getElementById('aiSummaryResult').textContent = result.summary || '–†–µ–∑—é–º–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ';
    document.getElementById('productivityFill').style.width = `${result.productivity}%`;
    document.getElementById('productivityScore').textContent = `${result.productivity}%`;
    const score = result.score || result.productivity || 0;
    document.getElementById('aiScoreDisplay').textContent = `${score}/100`;

    // –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –ì–†–ê–§–Ü–ö–ê
    loadChartData();
  }

  // –§—É–Ω–∫—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –º–∞–ª—é–≤–∞–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫–∞
  function loadChartData() {
    fetch('/api/ai/chart-data')
      .then(r => r.json())
      .then(data => {
        const ctx = document.getElementById('moodDynamicsChart').getContext('2d');
        
        // –Ø–∫—â–æ –≥—Ä–∞—Ñ—ñ–∫ –≤–∂–µ —ñ—Å–Ω—É—î - –∑–Ω–∏—â—É—î–º–æ –π–æ–≥–æ –ø–µ—Ä–µ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º –Ω–æ–≤–æ–≥–æ
        if (moodChartInstance) {
            moodChartInstance.destroy();
        }

        moodChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels, 
                datasets: [{
                    label: '–ù–∞—Å—Ç—Ä—ñ–π',
                    data: data.moods,
                    borderColor: '#ff7bb0',
                    backgroundColor: 'rgba(255, 123, 176, 0.2)',
                    tension: 0.4,
                    yAxisID: 'y'
                }, {
                    label: '–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å',
                    data: data.productivity.map(p => p / 10), // –ú–∞—Å—à—Ç–∞–±—É—î–º–æ 0-100 –¥–æ 0-10
                    borderColor: '#51cf66',
                    borderDash: [5, 5],
                    tension: 0.4,
                    yAxisID: 'y'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: '#ccc' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#ccc' }
                    }
                },
                plugins: {
                    legend: { labels: { color: '#fff' } }
                }
            }
        });
      })
      .catch(err => console.error("Chart error:", err));
  }

  // ===== EVENT LISTENERS =====
  document.addEventListener('DOMContentLoaded', () => {
    // 1. Mood Slider Logic
    const moodSlider = document.getElementById('moodRating');
    const moodEmoji = document.getElementById('moodEmoji');
    const moodValue = document.querySelector('.mood-value');

    if (moodSlider) {
      moodSlider.addEventListener('input', (e) => {
        const value = e.target.value;
        moodEmoji.textContent = getMoodEmoji(value);
        moodValue.textContent = value;
      });
    }

    // 2. Modal Close Logic
    const closeBtn = document.getElementById('closeDayEntryModal');
    const cancelBtn = document.getElementById('cancelDayEntryBtn');
    const overlay = document.getElementById('dayEntryModalOverlay');

    if (closeBtn) closeBtn.addEventListener('click', closeDayEntryModal);
    if (cancelBtn) cancelBtn.addEventListener('click', closeDayEntryModal);
    if (overlay) {
      overlay.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeDayEntryModal();
      });
    }

    // 3. Result Actions
    const newAnalysisBtn = document.getElementById('newAnalysisBtn');
    const closeResultsBtn = document.getElementById('closeResults');
    const saveAnalysisBtn = document.getElementById('saveAnalysisBtn');

    if (newAnalysisBtn) {
      newAnalysisBtn.addEventListener('click', () => {
        document.getElementById('dayEntryForm').style.display = 'block';
        document.getElementById('aiAnalysisResults').style.display = 'none';
        document.getElementById('dayEntryForm').reset();
      });
    }

    if (closeResultsBtn) {
      closeResultsBtn.addEventListener('click', () => {
        document.getElementById('aiAnalysisResults').style.display = 'none';
        document.getElementById('dayEntryForm').style.display = 'block';
      });
    }

    if (saveAnalysisBtn) {
      saveAnalysisBtn.addEventListener('click', () => {
        alert('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!');
        closeDayEntryModal();
        setTimeout(() => location.reload(), 500);
      });
    }

    // 4. MAIN FIX: Open Analysis Button Logic
    const analysisBtn = document.getElementById('openAnalysisBtn');
    if (analysisBtn) {
      analysisBtn.addEventListener('click', () => {
        // Find the selected date from the DOM
        const selectedDateEl = document.querySelector('.day-cell.selected');
        if (selectedDateEl) {
          const date = selectedDateEl.dataset.date;
          openDayEntryModal(date);
        } else {
          alert('–ë—É–¥—å –ª–∞—Å–∫–∞, —Å–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –¥–µ–Ω—å —É –∫–∞–ª–µ–Ω–¥–∞—Ä—ñ!');
        }
      });
    }

    // 5. Analysis Form Submit
    const form = document.getElementById('dayEntryForm');
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const description = document.getElementById('dayDescription').value;
        const moodRating = document.getElementById('moodRating').value;

        if (!description.trim()) {
          alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–ø–∏—à–∏ —Å–≤—ñ–π –¥–µ–Ω—å');
          return;
        }

        const btn = document.getElementById('submitDayEntryBtn');
        btn.disabled = true;
        btn.innerHTML = '<span>‚è≥ –ê–Ω–∞–ª—ñ–∑—É–≤–∞–Ω–Ω—è...</span>';

        try {
          const response = await fetch('/api/ai/analyze-entry', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              text: description,
              mood_rating: parseInt(moodRating),
              date: currentSelectedDate
            })
          });

          const result = await response.json();

          if (result.status === 'success') {
            showAnalysisResults(result);
          } else {
            alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –∞–Ω–∞–ª—ñ–∑—É: ' + (result.message || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'));
          }
        } catch (err) {
          alert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + err.message);
        } finally {
          btn.disabled = false;
          btn.innerHTML = `<span>–ê–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –¥–µ–Ω—å</span>`;
        }
      });
    }
  });
  
  // Rest of your existing variables/functions...
  let currentYear = JSON.parse('{{ current_year | default("0") }}');
  let currentMonth = JSON.parse('{{ current_month | default("1") }}');
  let selectedCategoryId = null;

  function qs(sel, root = document) { return root.querySelector(sel); }
  function qsa(sel, root = document) { return Array.from(root.querySelectorAll(sel)); }

  function escapeHtml(s) {
    if (!s) return '';
    return s.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
  }

  function formatDate(dateStr) {
    const date = new Date(dateStr + 'T00:00:00');
    const days = ['–ù–µ–¥—ñ–ª—è', '–ü–æ–Ω–µ–¥—ñ–ª–æ–∫', '–í—ñ–≤—Ç–æ—Ä–æ–∫', '–°–µ—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä', '–ü\'—è—Ç–Ω–∏—Ü—è', '–°—É–±–æ—Ç–∞'];
    const months = ['—Å—ñ—á–Ω—è', '–ª—é—Ç–æ–≥–æ', '–±–µ—Ä–µ–∑–Ω—è', '–∫–≤—ñ—Ç–Ω—è', '—Ç—Ä–∞–≤–Ω—è', '—á–µ—Ä–≤–Ω—è',
      '–ª–∏–ø–Ω—è', '—Å–µ—Ä–ø–Ω—è', '–≤–µ—Ä–µ—Å–Ω—è', '–∂–æ–≤—Ç–Ω—è', '–ª–∏—Å—Ç–æ–ø–∞–¥–∞', '–≥—Ä—É–¥–Ω—è'];
    return `${days[date.getDay()]}, ${date.getDate()} ${months[date.getMonth()]}`;
  }

  function switchTab(tabName) {
    qsa('.tab-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.tab === tabName);
    });
    qsa('.tab-content').forEach(content => {
      content.classList.toggle('active', content.id === 'tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
    });
  }

  function updateCategoryDisplay() {
    const display = qs('#selectedCategoryDisplay');
    qsa('.category-pill').forEach(p => p.classList.remove('active'));

    if (selectedCategoryId) {
      const pill = qs(`.category-pill[data-id="${selectedCategoryId}"]`);
      if (pill) {
        pill.classList.add('active');
        qs('#selectedCategoryIcon').textContent = pill.dataset.icon;
        qs('#selectedCategoryName').textContent = pill.dataset.name;
        display.style.display = 'flex';
      }
    } else {
      display.style.display = 'none';
    }
  }

  // ===== –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø loadTasks =====
  function loadTasks(date) {
    console.log('loadTasks: –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á –¥–ª—è', date);

    const panelTasks = qs('#panelTasks');
    const tasksCount = qs('#tasksCount');

    if (!panelTasks || !tasksCount) {
      console.error('ERROR: DOM elements not found!');
      return;
    }

    // –ü–æ–∫–∞–∑—É—î–º–æ loading
    panelTasks.innerHTML = '<div class="empty">‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';

    const url = `/planner/get_tasks/${date}`;
    console.log('Fetch URL:', url);

    fetch(url)
      .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
      })
      .then(tasks => {
        console.log('Tasks received:', tasks);
        console.log('Tasks count:', Array.isArray(tasks) ? tasks.length : 'NOT AN ARRAY');

        if (!Array.isArray(tasks) || tasks.length === 0) {
          console.log('No tasks or not an array');
          panelTasks.innerHTML = '<div class="empty">üìù –ù–µ–º–∞—î –∑–∞–¥–∞—á –Ω–∞ —Ü–µ–π –¥–µ–Ω—å<br><small>–ü–µ—Ä–µ–π–¥—ñ—Ç—å –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–°—Ç–≤–æ—Ä–∏—Ç–∏" —â–æ–± –¥–æ–¥–∞—Ç–∏</small></div>';
          tasksCount.textContent = '0';
          return;
        }

        // –û—á–∏—â—É—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        panelTasks.innerHTML = '';
        tasksCount.textContent = tasks.length;

        // –î–æ–¥–∞—î–º–æ –∫–æ–∂–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è
        tasks.forEach((task, index) => {
          console.log(`Creating task ${index + 1}:`, task.title);

          const row = document.createElement('div');
          row.className = 'panel-task-row';

          if (task.category) {
            row.classList.add('has-category');
            row.style.borderLeftColor = task.category.color;
          }

          const categoryHTML = task.category ? `<span class="panel-task-category">${task.category.icon}</span>` : '';
          const timeHTML = task.time ? `<div class="panel-task-time">‚è∞ ${task.time}</div>` : '';

          row.innerHTML = `
            <div class="left">
              <input type="checkbox" class="panel-task-checkbox" data-id="${task._id}" ${task.is_completed ? 'checked' : ''}/>
              ${categoryHTML}
              <div class="panel-task-info">
                <div class="panel-task-title">${escapeHtml(task.title)}</div>
                ${timeHTML}
              </div>
            </div>
            <div class="panel-task-actions">
              <button class="edit-task-btn" data-id="${task._id}" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
              </button>
              <button class="delete-task-btn-inline" data-id="${task._id}" title="–í–∏–¥–∞–ª–∏—Ç–∏">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
              </button>
            </div>
          `;

          // –ß–µ–∫–±–æ–∫—Å toggle
          row.querySelector('.panel-task-checkbox').addEventListener('change', () => {
            fetch(`/planner/toggle_task/${task._id}`, { method: 'POST' })
              .then(() => {
                loadTasks(date);
                refreshCalendar();
              })
              .catch(err => console.error('Toggle error:', err));
          });

          // –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
          row.querySelector('.edit-task-btn').addEventListener('click', () => {
            openEditForm(task);
          });

          // –í–∏–¥–∞–ª–µ–Ω–Ω—è
          row.querySelector('.delete-task-btn-inline').addEventListener('click', () => {
            if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è?')) {
              fetch(`/planner/delete_task/${task._id}`, { method: 'POST' })
                .then(r => r.json())
                .then(() => {
                  loadTasks(date);
                  refreshCalendar();
                })
                .catch(err => console.error('Delete error:', err));
            }
          });

          panelTasks.appendChild(row);
        });

        console.log('‚úÖ All tasks rendered successfully');
      })
      .catch(err => {
        console.error('ERROR in loadTasks:', err);
        panelTasks.innerHTML = `<div class="empty" style="color: #ff6b6b;">‚ùå –ü–æ–º–∏–ª–∫–∞: ${err.message}</div>`;
      });
  }

  function showPanelFor(date) {
    console.log('Show panel for date:', date);
    const panel = qs('#eventPanel');
    const calendarSection = qs('#calendarSection');

    qsa('.day-cell').forEach(el => el.classList.toggle('selected', el.dataset.date === date));
    qs('#panelDate').textContent = formatDate(date);

    panel.classList.remove('hidden');
    calendarSection.classList.remove('full-width');

    switchTab('tasks');
    resetForm();
    loadTasks(date);
  }

  function openEditForm(task) {
    switchTab('create');

    qs('#taskId').value = task._id;
    qs('#taskTitle').value = task.title;
    qs('#taskDescription').value = task.description || '';
    qs('#taskTime').value = task.time || '';
    qs('#deleteTaskBtn').style.display = 'inline-flex';
    qs('#saveTaskBtn').innerHTML = `
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
        <polyline points="17 21 17 13 7 13 7 21"/>
        <polyline points="7 3 7 8 15 8"/>
      </svg>
      <span>–û–Ω–æ–≤–∏—Ç–∏</span>
    `;

    if (task.category) {
      selectedCategoryId = task.category.id;
      updateCategoryDisplay();
    } else {
      selectedCategoryId = null;
      updateCategoryDisplay();
    }

    qs('#taskTitle').focus();
  }

  function resetForm() {
    const form = qs('#taskForm');
    if (form) form.reset();
    qs('#taskId').value = '';
    qs('#deleteTaskBtn').style.display = 'none';
    qs('#saveTaskBtn').innerHTML = `
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
        <polyline points="17 21 17 13 7 13 7 21"/>
        <polyline points="7 3 7 8 15 8"/>
      </svg>
      <span>–ó–±–µ—Ä–µ–≥—Ç–∏</span>
    `;
    selectedCategoryId = null;
    updateCategoryDisplay();
  }

  function refreshCalendar() {
    location.reload();
  }

  function changeMonth(offset) {
    currentMonth += offset;
    if (currentMonth > 12) { currentMonth = 1; currentYear++; }
    if (currentMonth < 1) { currentMonth = 12; currentYear--; }
    const params = new URLSearchParams({ month: currentMonth, year: currentYear });
    location.href = `${location.pathname}?${params.toString()}`;
  }

  // ===== MAIN INITIALIZATION =====
  document.addEventListener('DOMContentLoaded', () => {
    const panel = qs('#eventPanel');
    const calendarSection = qs('#calendarSection');

    panel.classList.add('hidden');
    calendarSection.classList.add('full-width');

    // –ì–æ–¥–∏–Ω–Ω–∏–∫
    function updateClock() {
      const now = new Date();
      qs('#currentTime').textContent = `üïê ${now.toLocaleTimeString('uk-UA')}`;
      qs('#currentDate').textContent = now.toLocaleDateString('uk-UA', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }
    updateClock();
    setInterval(updateClock, 1000);

    // –ö–Ω–æ–ø–∫–∏ –¥–Ω—ñ–≤
    qsa('.day-button').forEach(btn => {
      btn.addEventListener('click', e => {
        e.preventDefault();
        const date = btn.dataset.date;
        if (date) {
          showPanelFor(date);
        }
      });
    });

    // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –≤–∫–ª–∞–¥–æ–∫
    qsa('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        switchTab(btn.dataset.tab);
      });
    });

    // –í–∏–±—ñ—Ä –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
    qsa('.category-pill').forEach(pill => {
      pill.addEventListener('click', () => {
        const catId = pill.dataset.id;
        if (selectedCategoryId === catId) {
          selectedCategoryId = null;
        } else {
          selectedCategoryId = catId;
        }
        updateCategoryDisplay();
      });
    });

    // –û—á–∏—Å—Ç–∏—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é
    const clearCatBtn = qs('#clearCategory');
    if (clearCatBtn) {
      clearCatBtn.addEventListener('click', () => {
        selectedCategoryId = null;
        updateCategoryDisplay();
      });
    }

    // –°—Ç—ñ–∫–µ—Ä–∏ drag
    qsa('.sticker-btn').forEach(s => {
      s.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', s.dataset.sticker);
      });
    });

    qsa('.day-cell').forEach(cell => {
      if (cell.classList.contains('empty')) return;
      cell.addEventListener('dragover', e => e.preventDefault());
      cell.addEventListener('drop', e => {
        e.preventDefault();
        const sticker = e.dataTransfer.getData('text/plain');
        const date = cell.dataset.date;
        fetch('/planner/add_sticker', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date, sticker })
        }).then(() => refreshCalendar());
      });
    });

    // –ó–∞–∫—Ä–∏—Ç—Ç—è –ø–∞–Ω–µ–ª—ñ
    qs('#closePanel').addEventListener('click', () => {
      panel.classList.add('hidden');
      calendarSection.classList.add('full-width');
      qsa('.day-cell').forEach(el => el.classList.remove('selected'));
      resetForm();
    });

    // –ù–∞–≤—ñ–≥–∞—Ü—ñ—è –º—ñ—Å—è—Ü—è–º–∏
    qs('#prevMonth').addEventListener('click', () => changeMonth(-1));
    qs('#nextMonth').addEventListener('click', () => changeMonth(1));

    // –§–æ—Ä–º–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è/—Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è
    qs('#taskForm').addEventListener('submit', e => {
      e.preventDefault();
      const id = qs('#taskId').value || null;
      const currentDateForTask = qsa('.day-cell.selected')[0]?.dataset.date;

      if (!currentDateForTask) {
        alert('–û–±–µ—Ä—ñ—Ç—å –¥–µ–Ω—å –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è');
        return;
      }

      const payload = {
        title: qs('#taskTitle').value.trim(),
        description: qs('#taskDescription').value.trim(),
        time: qs('#taskTime').value || null,
        date: currentDateForTask,
        category_id: selectedCategoryId
      };

      const url = id ? `/planner/edit_task/${id}` : '/planner/add_task';
      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(r => r.json())
        .then(res => {
          if (res.error) return alert(res.error);

          resetForm();
          loadTasks(currentDateForTask);
          refreshCalendar();
          switchTab('tasks');
        }).catch(err => console.error(err));
    });

    // –í–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è –∑ —Ñ–æ—Ä–º–∏
    qs('#deleteTaskBtn').addEventListener('click', () => {
      const id = qs('#taskId').value;
      if (!id) return;
      if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è?')) return;

      fetch(`/planner/delete_task/${id}`, { method: 'POST' })
        .then(r => r.json())
        .then(res => {
          if (res.success) {
            const currentDateForTask = qsa('.day-cell.selected')[0]?.dataset.date;
            resetForm();
            loadTasks(currentDateForTask);
            refreshCalendar();
            switchTab('tasks');
          } else {
            alert(res.error || '–ü–æ–º–∏–ª–∫–∞');
          }
        });
    });

    // –ß–µ–∫–±–æ–∫—Å–∏ –≤ –ø—Ä–µ–≤—å—é –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    qsa('.task-preview-checkbox').forEach(cb => {
      cb.addEventListener('change', e => {
        e.stopPropagation();
        const id = cb.dataset.id;
        fetch(`/planner/toggle_task/${id}`, { method: 'POST' })
          .then(() => refreshCalendar());
      });
    });
  });
</script>
{% endblock %}